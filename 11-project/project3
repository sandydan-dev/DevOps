# Project 3

# Project Structure 

┌───────────────┐ → ┌──────────┐ → ┌─────────────────────┐ → ┌─────────────────┐
│ Git Server    │   │ GitHub   │   │ Jenkins Server (EC2) │   │ Docker Server   │
│ (EC2, Git)    │   │ Repo     │   │ Git | Java | Maven   │   │ Java | Tomcat   │
└───────────────┘   └──────────┘   │ Jenkins Jobs         │   │ Deploy WAR      │
                                   └─────────────────────┘   └─────────────────┘
                                                              │
                                                              │ builds / manages
                                                              ▼
                                                    ┌───────────────────────────┐
                                                    │       Docker Engine        │
                                                    │       Dockerfile           │
                                                    │       Tomcat Image         │
                                                    │       Docker Container     │
                                                    └───────────────────────────┘



1. Launch an EC2 instance for the Docker server using an appropriate Amazon Machine Image (AMI) that supports Docker (e.g., Amazon Linux 2, Ubuntu).

2. tomcat port is 8080 and container port is also 8080, so better we do port mapping while running the container.
   - like we change the base machine port to 8081 and container port to 8080.
   - base machine port:8081 -> container port:8080 
   - run on browser: http://docker-server-public-ip:8081

# First 

- cmd: docker run -d  -name docker-container -p 8081:8080 tomcat   

# Launch EC2 Instances for Docker-server
- name: docker-server
- type: t2.micro
- AMI: Amazon Linux
- security-group: same as jenkins-server (allowing port 8081 for tomcat access)
- key-pair: same as jenkins-server
- storage: 8 GB
> - launch the instance

# no need for elastic IP for docker-server

# go inside MobaXterm terminal for docker-server login

# change hostname
- go as root user 
cmd: sudo su -
cmd: vi /etc/hostname
change to: docker-server
:wq!  # save and exit

# reboot server
cmd: init 6  | or  reboot   # restart the server to apply hostname changes


# now install docker engine on docker-server
cmd: yum install docker -y       # install docker engine
cmd: systemctl start docker      # start docker service
cmd: systemctl enable docker    # enable docker service at boot time

# verify docker installation
cmd: docker --version           # shows docker version
cmd: docker info              # shows docker details


# Now pull tomcat image from docker hub
cmd: docker pull tomcat:latest   # pull latest tomcat image from docker hub

> now verify image is downloaded
cmd: docker images               # shows downloaded docker images

# Now run tomcat container from the pulled image
cmd: docker run -d --name tomcat-container -p 8081:8080 tomcat:latest  # run tomcat container with port mapping, and detached mode, means run in background or countinuously running in background

  - name: tomcat-container # container name
  - port mapping: host machine port:8081 -> container port:8080  # port mapping, base machine port to container port
  - detached mode: -d       # run container in background
  - image: tomcat:latest # image name with tag
- now verify container is running
cmd: docker ps              # shows running containers  

- now access tomcat server on browser
- take instance public IP of docker-server
- open browser and type: http://docker-server-public-ip:8081 # access tomcat server

- but here is the problem, we showing 404 error page not found,
- because tomcat image have default it self

- first go inside the container 
cmd: docker exec -it tomcat-container /bin/bash   # go inside the container terminal

cmd: ls

- we directly entered into "/usr/local/tomcat" folder

cmd: there is 2 folders like "webapps" and "webapps.dist"
- webapps: is the folder where we need to deploy our war file
- webapps.dist: is the default tomcat webapps folder

> Copy war file from webapps.dist to webapps folder
cmd: cp -R webapps.dist/* webapps/   # copy all files from webapps.dist to webapps folder

- now exit from container
cmd: exit

- now restart the tomcat container to apply changes
cmd: docker restart tomcat-container   # restart the container

- now run instance ip on browser 
- open browser and type: http://docker-server-public-ip:8081  # access tomcat server (http://13.60.30.62:8081/)

- now we can see tomcat welcome page

# For now delete the container 
- first stop the container
cmd: docker stop tomcat-container   # stop the container

- then remove the container
cmd: docker rm tomcat-container     # remove the container

# We need to automate this process using Dockerfile 
# Create a Dockerfile to automate the tomcat setup with war deployment

# Create Dockerfile
cmd: vi Dockerfile
# Dockerfile content
FROM tomcat:latest
RUN cp -R /usr/local/tomcat/webapps.dist/* /usr/local/tomcat/webapps/
COPY your-application.war /usr/local/tomcat/webapps/      # copy your war file to webapps folder
# save and exit :wq!

# Build Docker Image from Dockerfile
cmd: docker build -t demotomcat .  # build image with tag demo-tomcat-img from current directory

# Run Container from the newly built image (demotomcat)
cmd: docker run -d --name demotomcat-container -p 8082:8080 demotomcat   # run container from demotomcat image with port mapping

# but still manager apps is not working because by default its disabled in tomcat image
# we need to enable it by creating user with manager role in tomcat-users.xml file

# there is SSH connection, means universal connection between jenkins-server and docker-server
- to connect docker-server from jenkins-server using SSH connection, 
- we need username, password, ip address of docker-server instance 
- also modify sshd config file to allow password authentication


- and then enter those details in jenkins-server SSH connection setup, inside credentials
- first create a user in docker-server
cmd: adduser dockeradmin    # create user dockeradmin
cmd: passwd dockeradmin     # set password for dockeradmin user
    - enter password: Docker@123
    - re-enter password: Docker@123

# whenever we install docker by default it create docker group automatically
- verify docker group is created
cmd: cat /etc/group | grep docker   # shows docker group details
   - ouput: docker:x:992:  # docker group is created    

# now add dockeradmin user to docker group to run docker commands without sudo, without any permission issues
cmd: usermod -aG docker dockeradmin

- verify user is added to docker group
cmd: cat /etc/group | grep docker   # shows docker group details
   - output: docker:x:992:dockeradmin  # dockeradmin user is added to docker group

# now modify sshd config file to allow password authentication
cmd: vi /etc/ssh/sshd_config
- find: PasswordAuthentication no
  - change to: PasswordAuthentication yes
:wq!   # save and exit 

# now restart sshd service to apply changes
cmd: service sshd reload       # reload sshd service


# Now we have username, password, ip address of docker-server

- now go to jenkins-server to create SSH connection to docker-server
- go to jenkins dashboard
- go to Manage Jenkins
- got to system 

> we already installed plugin like "publish over ssh" in jenkins-server
- scoll down to "Publish over SSH" section
- add ssh server
  - name: docker-host     # recognizable name 
  - hostname: <docker-server-private-ip>   # take docker-server private ip or dns address   
  - username: dockeradmin
  - to to "Advanced" button
    - check "Use password authentication, or use a different key"
    - enter password: dockeradmin  # (the password we set while creating user in docker-server instance (mobaXterm))
- click on "Test Configuration" button
  - if connection is successful, we get success message
  - if failed, check all details and try again

- then "apply" and "save"
- now test the connection

> Now our Integration part is done between jenkins-server and docker-server using SSH connection

# Now create a Jenkins job to build and deploy war file to docker-server
- go to jenkins dashboard
- click on "New Item"
- enter item name: BuildAndDeployContainer
- choose: previously created maven project
- click OK

  > after job is created, automatically go to job configuration page
    - go to "Source Code Management" section
      - choose: Git
      - enter repository URL: <github-repo-url>   # enter your github repo url
      - enter credentials if required
      - enter branch: main   # enter your branch name
     
    - go to "Build" section
      - Root POM: pom.xml
        - Goals and options: clean package  # clear old war file and build new war file

    - go to "Post-build Actions" section
      - choose: "Send build artifacts over SSH"
      - SSH Server: docker-host   # the ssh server we created earlier
        - Transfer set
          - source file: webapps/target/*.war   # path where jenkins build war file    
            - remove prefix: webapps/target/   # to remove unwanted path part from source file path, only war file should be copied
            - remote directory: /usr/local/tomcat/webapps/   # path inside docker-server tomcat webapps folder
          - Exec command
           # commands to run after file transfer, remove old and add new one


          - apply and save 
           


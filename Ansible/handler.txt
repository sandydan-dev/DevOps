# Dependency Handler script for ansible

# Dependency task, which handle like if one task done then move to next task 
- like httpd
  - first install httpd package then start httpd service
if one task is not done, it will not give you such kind of result like, it wait for first task, if first task is done then it will move to 2nd task   

# What is an Ansible handler ?
> A handler is a special task that runs only when another task notify it.
  
  - A handler is a task that runs only when need. 
  - It is triggered (notify) by another task.
  - Usually used for actions like restart services. 

# Why do we use handlers?
- Somethings you change a configuration file, and after that change, you must restart a service. 

ðŸŸ¢ But, restart the service every time is not good. 
ðŸŸ¢ So, Ansible restart it only when the file actually changes.

- this is "conditional restart" is done using handlers. 


> For Example:
 - You chagne the httpd cofig file.
 - only if the file changed, restart apache. 

# -------------------------------------------------------- #

# create handler task 
cmd: vi handler_install_httpd.yml 
--- 
- name: Dependency task (handler)
  hosts: all
  become: yes 
  tasks:
   - name: install httpd package (first task)
     yum:
       name: httpd
        state: present
     notify: start httpd installation first    # add same name as handler (conditonal)

  handlers:
    - name start httpd installation first 
      service:
       name: httpd 
       state: started

# -------- end file -------- #

> run playbook 
cmd: ansible-playbook handler_install_httpd.yml 

> notify: and handler must match 

# --------------------------------------------------- #

# handler task = install nginx server and then add config file for nginx setup
# Nginx has its own behaviour  and we control it using configuration file 

# notify + handler works

             TASK CHANGED? 
                  |
        +---------+---------+
        |                   |
       YES                 NO
        |                   |
   Trigger Handler       Do Nothing
        |             
   (restart/reload)



# --------------------------------------------------- #


# install nginx server
cmd: vi handler_nginx.yml
---
- name: Install nginx on Amazon Linux 2023 and deploy website
  hosts: all
  become: yes

  tasks:

    - name: Install nginx using dnf
      dnf:
        name: nginx
        state: present
      notify: restart nginx service

    - name: Enable nginx service
      service:
        name: nginx
        enabled: yes

    - name: Copy index.html to nginx default path
      copy:
        src: index.html
        dest: /usr/share/nginx/html/index.html
      notify: restart nginx service

  handlers:
    - name: restart nginx service
      service:
        name: nginx
        state: restarted


# ------ end file ------ #

# task 1: install nginx server 
- if nginx server installed/updated > notify handlers.

# task 2: copy index.html 
- if file changes > notify handler again 

# handler only runs once at the end 
- Even if 2 tasks notify, handler runs only one time > avoid unneccessary restart. 


# now run playbook
cmd: ansible-playbook handler_nginx.yml 


# --------------------------------------------------- #


# Different OS have, so how write script Upon OS 

> if nodes have different-different OS(AMI) so how to handle it through main serve.
- then it comes "when" keyword condition for ex. we have 2 different OS like 
  Amazon-Linux and Debian Ubuntu andinstall package in different nodes in different cmd like 
  "apt" and "yum"

# create playbook file 
cmd: vi install_apache.yml 
---
- name: if different os family in different nodes, so use "when" conditional"
  hosts: all
  become: yes

  tasks:

    # RedHat family
    - name: Install httpd package
      yum:
        name: httpd
        state: present
      when: ansible_os_family == "RedHat"

    - name: start httpd service
      service:
        name: httpd
        state: started
      when: ansible_os_family == "RedHat"

    # Debian family
    - name: install apache2 server
      apt:
        name: apache2
        state: present
      when: ansible_os_family == "Debian"

    - name: start apache2 service
      service:
        name: apache2
        state: started
      when: ansible_os_family == "Debian"


> it will install package and start service based on OS with conditional based.
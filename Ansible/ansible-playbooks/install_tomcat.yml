---
- name: install java and tomcat                   # name of the playbook
  hosts: all                                      # run all servers in the inventory
  become: true                                    # use sudo (root access)

  tasks:                                          # start of tasks 


    # ================================================================
    # Install Java 21 Amazon Corretto on RedHat/Amazon Linux/CentOS
    # ================================================================

   - name: Install Amazon Corretto 21 (RPM package)
     yum:                                         # use yum package manager (module)
      name: java-21-amazon-corretto               # correct pkg name of java 21
      state: present                              # ensure java installed
     when: ansible_os_family == "RedHat"          # only runs if OS is RedHat family 

    # ================================================================
    # Install Java on Debian/Ubuntu
    # (You can replace this with Debian Corretto if needed)
    # ================================================================     

   - name: Install java on debian family 
     apt:                                         # Use apt package manager
      name: default-jdk                           # Default JDK for Debian/Ubuntu
      state: present                              # Ensure Java is installed
     when: ansible_os_family == "Debian"          # Only run if OS is Debian family

    # ================================================================
    # Download Tomcat tar.gz file
    # ================================================================

   - name: download tomcat version   
     get_url:                                     # Downloads files from a URL
      url: https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.112/bin/apache-tomcat-9.0.112.tar.gz    # URL to Tomcat 9 installer (tar.gz)
      dest: /opt/apache-tomcat-9.0.112.tar.gz     # Save file in /opt directory      

    # ================================================================
    # Extract Tomcat
    # ================================================================

   - name: extract tomcat 
     unarchive:                                   # Module to extract tar.gz, zip, etc.
      src: /opt/apache-tomcat-9.0.112.tar.gz      # Path of the downloaded tar.gz file
      dest: /opt                                  # Extract into /opt directory
      remote_src: yes                             # File is already on the remote server

    # ================================================================
    # Give execute permission to startup.sh
    # ================================================================  

   - name: executable program permission for .startup.sh 
     file:                                         # Module to set file properties
      path: /opt/apache-tomcat-9.0.112/bin/startup.sh   # Path to Tomcat startup script
      mode: 0777                                         # Make file executable (rwx-rwx-rwx)

    # ================================================================
    # Run Tomcat using nohup (runs continuously in background)
    # ================================================================  
 
   - name: run startup.sh in background
     shell: nohup ./startup.sh &                    # nohup = ignore hangup, & = run in background
     args:
      chdir: /opt/apache-tomcat-9.0.112/bin         # Change to Tomcat bin directory before running